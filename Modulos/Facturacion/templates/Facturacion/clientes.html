{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cat√°logo de Clientes</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CSS personalizado -->
  <link rel="stylesheet" href="{% static 'css/clientes.css' %}?v={{ now|date:'His' }}">
</head>
<body>

<div class="overlay"></div>

<div class="container py-5 text-center">
  <h2 class="titulo mb-4">üìã Cat√°logo de Clientes</h2>

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <a href="{% url 'menu_catalogos' %}" class="btn btn-secondary">‚Üê Volver a Cat√°logos</a>

    <div class="d-flex align-items-center gap-3">
      <!-- üîç Buscador -->
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" id="filtroClientes" class="form-control" placeholder="Buscar por nombre o DUI">
      </div>

      <button class="btn btn-agregar" data-bs-toggle="modal" data-bs-target="#modalCliente">
        + Agregar Cliente
      </button>
    </div>
  </div>

  <!-- üîπ Tabla de clientes -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle" id="tablaClientes">
      <thead class="table-encabezado">
        <tr>
          <th>#</th>
          <th>Nombre</th>
          <th>DUI</th>
          <th>NIT</th>
          <th>NRC</th>
          <th>Direcci√≥n</th>
          <th>Correo</th>
          <th>Tel√©fono</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for cliente in clientes %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ cliente.nombre }}</td>
          <td>{{ cliente.dui }}</td>
          <td>{{ cliente.nit }}</td>
          <td>{{ cliente.nrc }}</td>
          <td>{{ cliente.direccion }}</td>
          <td>{{ cliente.correo }}</td>
          <td>{{ cliente.telefono }}</td>
          <td class="text-center">
            <!-- Bot√≥n Editar -->
            <button class="btn btn-editar btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditarCliente"
                    data-url="{% url 'editar_cliente' cliente.id %}">
              ‚úèÔ∏è Editar
            </button>

            <!-- Bot√≥n Eliminar -->
            <a href="{% url 'eliminar_cliente' cliente.id %}" 
               class="btn btn-eliminar btn-sm" 
               onclick="return confirm('¬øSeguro que deseas eliminar este cliente?')">
               üóë Eliminar
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center text-light">No hay clientes registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- üîπ MODAL AGREGAR -->
<div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‚ûï Registrar Nuevo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="formClienteBody">
        <div class="text-center py-3 text-muted">Cargando formulario...</div>
      </div>
    </div>
  </div>
</div>

<!-- üîπ MODAL EDITAR -->
<div class="modal fade" id="modalEditarCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">‚úèÔ∏è Editar Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="formEditarClienteBody">
        <div class="text-center py-3 text-muted">Cargando formulario...</div>
      </div>
    </div>
  </div>
</div>

<!-- üîπ Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // ========= FILTRO DE CLIENTES (con restauraci√≥n autom√°tica) ==========
  const filtro = document.getElementById("filtroClientes");
  const tabla = document.getElementById("tablaClientes").getElementsByTagName("tbody")[0];
  const filasOriginales = Array.from(tabla.querySelectorAll("tr")).slice(0, 20);

  filtro.addEventListener("keyup", function() {
    const texto = this.value.toLowerCase().trim();
    const filas = tabla.getElementsByTagName("tr");

    if (texto === "") {
      tabla.innerHTML = "";
      filasOriginales.forEach(fila => tabla.appendChild(fila.cloneNode(true)));
      return;
    }

    for (let fila of filas) {
      const nombre = fila.cells[1]?.textContent.toLowerCase() || "";
      const dui = fila.cells[2]?.textContent.toLowerCase() || "";
      fila.style.display = (nombre.includes(texto) || dui.includes(texto)) ? "" : "none";
    }
  });

  // ========= MODAL AGREGAR ==========
  const modalCliente = document.getElementById('modalCliente');
  const formContainer = document.getElementById('formClienteBody');

  modalCliente.addEventListener('show.bs.modal', () => {
    formContainer.innerHTML = '<div class="text-center py-3 text-muted">Cargando formulario...</div>';
    fetch("{% url 'crear_cliente' %}")
      .then(res => res.text())
      .then(html => { formContainer.innerHTML = html; })
      .catch(() => { formContainer.innerHTML = '<p class="text-danger text-center">Error al cargar el formulario.</p>'; });
  });

  // ========= MODAL EDITAR ==========
  const modalEditar = document.getElementById('modalEditarCliente');
  const formEditar = document.getElementById('formEditarClienteBody');

  modalEditar.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const url = button.getAttribute('data-url');
    formEditar.innerHTML = '<div class="text-center py-3 text-muted">Cargando formulario...</div>';
    fetch(url)
      .then(res => res.text())
      .then(html => { formEditar.innerHTML = html; })
      .catch(() => { formEditar.innerHTML = '<p class="text-danger text-center">Error al cargar el formulario.</p>'; });
  });

  // ========= ENV√çO DE FORMULARIOS (Agregar / Editar) ==========
  document.addEventListener('submit', (e) => {
    if (e.target.matches('#formClienteBody form') || e.target.matches('#formEditarClienteBody form')) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);

      fetch(form.action, { method: 'POST', body: data })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();

            // ‚úÖ Actualiza solo la tabla
            fetch(window.location.href)
              .then(res => res.text())
              .then(html => {
                const parser = new DOMParser();
                const nuevaTabla = parser.parseFromString(html, 'text/html')
                                         .querySelector('#tablaClientes tbody');
                document.querySelector('#tablaClientes tbody').innerHTML = nuevaTabla.innerHTML;
              });
          } else {
            alert(data.error || 'Error al guardar los cambios.');
          }
        })
        .catch(() => alert('Error al enviar el formulario.'));
    }
  });
});
</script>

</body>
</html>


