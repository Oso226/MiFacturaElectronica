{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cat√°logo de Proveedores</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/registroproveedores2.css' %}">
</head>
<body class="fondo-fijo">

  <div class="container py-5 text-center contenido-principal">
    <h2 class="titulo mb-4">üè¢ Cat√°logo de Proveedores</h2>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <a href="{% url 'menu_catalogos' %}" class="btn btn-secondary">‚Üê Volver a Cat√°logos</a>

      <div class="d-flex align-items-center gap-3">
        <!-- üîç Buscador -->
        <form method="get" class="d-flex search-box">
          <i class="bi bi-search"></i>
          <input type="text" name="q" class="form-control" placeholder="Buscar por nombre o NIT" value="{{ query|default:'' }}">
        </form>

        <button class="btn btn-agregar" data-bs-toggle="modal" data-bs-target="#modalProveedor">Agregar Proveedor</button>
      </div>
    </div>


  <!-- üîπ Tabla -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-encabezado">
        <tr>
          <th>#</th>
          <th>Nombre</th>
          <th>NIT</th>
          <th>NRC</th>
          <th>Direcci√≥n</th>
          <th>Tel√©fono</th>
          <th>Correo</th>
          <th>Representante</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for proveedor in proveedores %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ proveedor.nombre }}</td>
          <td>{{ proveedor.nit }}</td>
          <td>{{ proveedor.nrc }}</td>
          <td>{{ proveedor.direccion }}</td>
          <td>{{ proveedor.telefono }}</td>
          <td>{{ proveedor.correo }}</td>
          <td>{{ proveedor.representante }}</td>
          <td>
            <button class="btn btn-editar btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditarProveedor"
                    data-url="{% url 'editar_proveedor' proveedor.id %}">
              ‚úèÔ∏è Editar
            </button>
            <a href="{% url 'eliminar_proveedor' proveedor.id %}" class="btn btn-eliminar btn-sm" onclick="return confirm('¬øSeguro que deseas eliminar este proveedor?')">üóë Eliminar</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center text-muted">No hay proveedores registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- üîπ MODAL NUEVO PROVEEDOR -->
<div class="modal fade" id="modalProveedor" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‚ûï Registrar Nuevo Proveedor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="formProveedorBody">
        <div class="text-center py-3 text-muted">Cargando formulario...</div>
      </div>
    </div>
  </div>
</div>

<!-- üîπ MODAL EDITAR PROVEEDOR -->
<div class="modal fade" id="modalEditarProveedor" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">‚úèÔ∏è Editar Proveedor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="formEditarProveedorBody">
        <div class="text-center py-3 text-muted">Cargando formulario...</div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // ========= MODAL AGREGAR ==========
  const modalProveedor = document.getElementById('modalProveedor');
  const formContainer = document.getElementById('formProveedorBody');

  modalProveedor.addEventListener('show.bs.modal', () => {
      formContainer.innerHTML = '<div class="text-center py-3 text-muted">Cargando formulario...</div>';
      fetch("{% url 'crear_proveedor' %}")
          .then(res => res.text())
          .then(html => { formContainer.innerHTML = html; })
          .catch(() => { formContainer.innerHTML = '<p class="text-danger text-center">Error al cargar el formulario.</p>'; });
  });

  // ========= MODAL EDITAR ==========
  const modalEditar = document.getElementById('modalEditarProveedor');
  const formEditar = document.getElementById('formEditarProveedorBody');

  modalEditar.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const url = button.getAttribute('data-url');
      formEditar.innerHTML = '<div class="text-center py-3 text-muted">Cargando formulario...</div>';
      fetch(url)
          .then(res => res.text())
          .then(html => { formEditar.innerHTML = html; })
          .catch(() => { formEditar.innerHTML = '<p class="text-danger text-center">Error al cargar el formulario.</p>'; });
  });

  // ========= ENV√çO DE FORMULARIOS ==========
  document.addEventListener('submit', (e) => {
      if (e.target.matches('#formProveedorBody form') || e.target.matches('#formEditarProveedorBody form')) {
          e.preventDefault();
          const form = e.target;
          const data = new FormData(form);

          fetch(form.action, { method: 'POST', body: data })
              .then(res => res.json())
              .then(data => {
                  if (data.success) {
                      const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                      modal.hide();
                      location.reload();
                  } else {
                      alert(data.error || 'Error al guardar los cambios.');
                  }
              })
              .catch(() => alert('Error al enviar el formulario.'));
      }
  });
});
</script>
</body>
</html>
